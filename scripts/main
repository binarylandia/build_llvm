#!/usr/bin/env bash

set -euxo pipefail

LLVM_REPO_URL="https://github.com/llvm/llvm-project"
LLVM_VER="llvmorg-19.1.2"

BUILD_DIR=".build"
INSTALL_DIR="/opt/llvm"
OUT_DIR=".out"

NICE="nice -19 ionice -c2 -n5"
JOBS="${JOBS:=$(($(nproc --all) + 2))}"

build_time="$(date '+%Y%m%d%H%M%S')"

function abspath() {
  readlink -m "$1"
}

function log() {
  tee -a "${1}" | stdbuf -oL grep --color=always -iE "error|fail|cannot|can't|unable|"
}

write_version() {
  filepath="${1}"

  cat > "$filepath" << EOF
${LLVM_REPO_URL}
${LLVM_VER}
$(git rev-parse HEAD)
$(git describe --always --dirty)
$(git describe --always --dirty --tags)
$(git describe --always --dirty --tags --all)
${build_time}
EOF
}

build_dir="$(abspath ${BUILD_DIR})"
mkdir -p "${build_dir}"
outdir="$(abspath "${OUT_DIR}")"
mkdir -p "${outdir}"

pushd "$build_dir" >/dev/null
  src_dir="llvm-${LLVM_VER}"

  if [ ! -d "${src_dir}" ]; then
    git clone --recursive --depth=100 -b "${LLVM_VER}" "${LLVM_REPO_URL}" "${src_dir}"
  fi

  pushd "${src_dir}" >/dev/null

    export CMAKE_TOOLCHAIN_FILE="/usr/toolchain-x86_64-unknown-linux-musl.cmake"
    export CFLAGS="-g0 -Os ${CFLAGS:+:CFLAGS}"
    export CXXFLAGS="-g0 -Os ${CXXFLAGS:+:CXXFLAGS}"

    ${NICE} cmake -S llvm -B "build" \
      -LAH -Wno-dev -Wno-deprecated \
      -DCMAKE_BUILD_TYPE="Release" \
      -DCMAKE_INSTALL_PREFIX="${INSTALL_DIR}" \
      -DCMAKE_VERBOSE_MAKEFILE="OFF" \
      -DLLVM_BUILD_TESTS="OFF" \
      -DLLVM_ENABLE_PROJECTS="clang;lld;lldb" \
      -DLLVM_INCLUDE_BENCHMARKS="OFF" \
      -DLLVM_INCLUDE_EXAMPLES="OFF" \
      -DLLVM_INCLUDE_TESTS="OFF" \
      -DPYTHON_EXECUTABLE="/conda/bin/python3" \
      2>&1 | log "build.log"

#      -DLLVM_BUILD_MLIR="OFF" \
#      -DLLVM_TOOL_LLDB_BUILD=1 \
#      -DLLVM_ENABLE_FFI=1 \
#      -DLLVM_CCACHE_BUILD=1 \
#      -DLLVM_BINUTILS_INCDIR="${OPT_DIR}/binutils/include" \
#      -DLLVM_ENABLE_DOXYGEN=0 \
#      -DLLVM_ENABLE_OCAMLDOC=0 \
#      -DLIBCXX_ENABLE_PARALLEL_ALGORITHMS=0 \
#      -DCMAKE_C_FLAGS="-I/usr/include/x86_64-linux-gnu" \
#      -DCMAKE_CXX_FLAGS="-I/usr/include/x86_64-linux-gnu" \

    ${NICE} cmake --build "build" --parallel="${JOBS}" 2>&1 | log "build.log"

    ${NICE} cmake --install "build" 2>&1 | log "build.log"

    write_version "${INSTALL_DIR}/version.txt"
    cp "build.log" "${INSTALL_DIR}/"
    tar -cf - -C "${INSTALL_DIR}" . | xz -T0 -9 > "${outdir}/llvm-${LLVM_VER}-static-${build_time}.tar.xz"
  popd >/dev/null
popd >/dev/null

